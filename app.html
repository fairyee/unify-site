<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì´ë¯¸ì§€ í¸ì§‘ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 960px;
      margin: 0 auto;
      padding: 24px;
      background: #f5f5f8;
    }
    h1 {
      margin-bottom: 4px;
    }
    p.subtitle {
      margin-top: 0;
      margin-bottom: 16px;
      color: #555;
      font-size: 14px;
    }
    .panel {
      background: #ffffff;
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .panel strong {
      display: block;
      margin-bottom: 8px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
    }
    input[type="number"],
    input[type="text"],
    select {
      padding: 4px 6px;
      font-size: 13px;
      margin-left: 4px;
    }
    input[type="range"] {
      width: 180px;
      vertical-align: middle;
      margin: 0 4px;
    }
    input[type="file"] {
      margin-top: 6px;
    }
    button {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      background: #2563eb;
      color: #fff;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    #result {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .result-item {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    /* ë°”ê¹¥ ì²´í¬ë¬´ëŠ¬ (íˆ¬ëª… í™•ì¸ìš©) */
    .result-preview-frame {
      width: 260px;
      height: 260px;
      border-radius: 4px;

      background-color: #f0f0f0;
      background-image:
        linear-gradient(45deg,
          #d0d0d0 25%, transparent 25%,
          transparent 50%, #d0d0d0 50%,
          #d0d0d0 75%, transparent 75%, transparent);
      background-size: 16px 16px;

      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    /* ì‹¤ì œ ê²°ê³¼ PNGë¥¼ ì˜¬ë¦¬ëŠ” ë ˆì´ì–´ */
    .result-preview-img {
      width: 100%;
      height: 100%;
      background-repeat: no-repeat;
      background-position: center;
      background-size: contain;
    }

    .download-btn {
      margin-top: 6px;
      padding: 4px 10px;
      font-size: 12px;
      background: #10b981;
      color: #fff;
    }
    .slider-value {
      display: inline-block;
      min-width: 24px;
      text-align: right;
      font-size: 12px;
      color: #444;
    }
    .hint {
      font-size: 12px;
      color: #777;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h1>ì´ë¯¸ì§€ í¸ì§‘ê¸°</h1>
  <p class="subtitle">ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ë°°ê²½, í¬ê¸°, ìƒ‰, í…ìŠ¤íŠ¸ ë“±ì„ ê°„ë‹¨íˆ ì¡°ì •í•´ ë³´ì„¸ìš”.</p>

  <form id="editForm">
    <!-- 1. ì´ë¯¸ì§€ ì„ íƒ -->
    <div class="panel">
      <strong>1. ì´ë¯¸ì§€ ì„ íƒ</strong>
      <label>
        í¸ì§‘í•  ì´ë¯¸ì§€(ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)
        <input type="file" id="images" name="images" multiple accept="image/*" />
      </label>
    </div>

    <!-- 2. ë°°ê²½ ì œê±° ì„¤ì • (AI + ì˜ˆì „ ë°©ì‹) -->
    <div class="panel">
      <strong>2. ë°°ê²½ ì œê±°</strong>
      <label>
        <input type="checkbox" id="useAiBg" checked />
        AIë¡œ ë°°ê²½ ì œê±° (ê¶Œì¥, ë” ê¹”ë”í•¨)
      </label>
      <div class="hint">
        ì‚¬ëŒ/ë™ë¬¼/ë¬¼ì²´ê°€ ìˆëŠ” ê·¸ë¦¼, ë³µì¡í•œ ë°°ê²½ì—ë„ ì˜ ë™ì‘í•©ë‹ˆë‹¤.<br />
        ì²« ì‚¬ìš© ì‹œ ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ëŠë¼ ì•½ê°„ ëŠë¦´ ìˆ˜ ìˆì–´ìš”.
      </div>
      <hr style="margin:12px 0; border:none; border-top:1px solid #eee;" />
      <label>
        <input type="checkbox" id="makeTransparent" />
        ë‹¨ìƒ‰ ë°°ê²½ë§Œ ê°„ë‹¨í•˜ê²Œ íˆ¬ëª… ì²˜ë¦¬ (AI ë¯¸ì‚¬ìš© ì‹œì—ë§Œ ì‚¬ìš©)
      </label>
      <div class="hint">
        í°(ë˜ëŠ” ì—°í•œ ë‹¨ìƒ‰) ì¢…ì´ ìœ„ì— ê·¸ë¦° ê·¸ë¦¼ì²˜ëŸ¼ ë°°ê²½ ìƒ‰ì´ ê±°ì˜ í•œ ê°€ì§€ì¼ ë•Œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
      </div>
    </div>

    <!-- 3. í¬ê¸° ì„¤ì • -->
    <div class="panel">
      <strong>3. í¬ê¸° ì„¤ì •</strong>
      <label>
        <input type="checkbox" id="doResize" checked />
        í¬ê¸° ë³€ê²½ ì‚¬ìš©
      </label>
      <label>
        ë„ˆë¹„
        <input type="number" id="width" value="512" min="16" max="4096" /> px
      </label>
      <label>
        ë†’ì´
        <input type="number" id="height" value="512" min="16" max="4096" /> px
      </label>
      <label>
        ë¹„ìœ¨ ìœ ì§€
        <input type="checkbox" id="keepRatio" checked />
      </label>
      <label>
        ë§ì¶”ëŠ” ë°©ì‹
        <select id="fitMode">
          <option value="contain">contain (ì˜ë¦¬ì§€ ì•Šê³  ì—¬ë°±)</option>
          <option value="cover">cover (ì˜ë¼ë„ ê½‰ ì±„ìš°ê¸°)</option>
          <option value="fill">fill (ë¹„ìœ¨ ë¬´ì‹œí•˜ê³  ê°•ì œ)</option>
        </select>
      </label>
    </div>

    <!-- 4. ìƒ‰ê° -->
    <div class="panel">
      <strong>4. ìƒ‰ê°</strong>
      <label>
        ë°ê¸°
        <input type="range" id="brightness" min="-50" max="50" value="0" />
        <span class="slider-value" id="brightnessVal">0</span>
      </label>
      <label>
        ì±„ë„
        <input type="range" id="saturation" min="-50" max="50" value="0" />
        <span class="slider-value" id="saturationVal">0</span>
      </label>
      <label>
        ëŒ€ë¹„
        <input type="range" id="contrast" min="-50" max="50" value="0" />
        <span class="slider-value" id="contrastVal">0</span>
      </label>
      <label>
        ìƒ‰ì¡°(Hue)
        <input type="range" id="hue" min="-180" max="180" value="0" />
        <span class="slider-value" id="hueVal">0</span>
      </label>
    </div>

    <!-- 5. ì„ (ë¼ì¸) ì„¤ì • -->
    <div class="panel">
      <strong>5. ì„ (ë¼ì¸) ì„¤ì •</strong>
      <label>
        ì„  ì§„í•˜ê²Œ/ì—°í•˜ê²Œ
        <input type="range" id="lineStrength" min="-50" max="50" value="0" />
        <span class="slider-value" id="lineStrengthVal">0</span>
      </label>
      <label>
        ì„  ìƒ‰ìƒ
        <select id="lineColor">
          <option value="original">ì›ë˜ ìƒ‰</option>
          <option value="brown">ë¸Œë¼ìš´</option>
          <option value="navy">ë„¤ì´ë¹„</option>
          <option value="white">í™”ì´íŠ¸</option>
        </select>
      </label>
      <div class="hint">
        â€» ì„  ì¸ì‹ì€ ì–´ë‘ìš´ í”½ì…€ ê¸°ì¤€ì´ë¼ ê·¸ë¦¼ì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ìš”.
      </div>
    </div>

    <!-- 6. í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ -->
    <div class="panel">
      <strong>6. í…ìŠ¤íŠ¸ ì¶”ê°€ (ì„ íƒ)</strong>
      <label>
        ë‚´ìš©
        <input type="text" id="overlayText" placeholder="ì˜ˆ: SAMPLE, DRAFT, êµ¬ë¦„ì–‘ ë“±" />
      </label>
      <label>
        ê¸€ì í¬ê¸°
        <input type="number" id="textSize" value="32" min="8" max="200" /> px
      </label>
      <label>
        ê¸€ì ìƒ‰
        <select id="textColor">
          <option value="white">í™”ì´íŠ¸</option>
          <option value="black">ë¸”ë™</option>
          <option value="brown">ë¸Œë¼ìš´</option>
        </select>
      </label>
      <label>
        ìœ„ì¹˜
        <select id="textPosition">
          <option value="bottom">ì•„ë˜ìª½</option>
          <option value="top">ìœ„ìª½</option>
        </select>
      </label>
    </div>

    <!-- ì‹¤í–‰ ë²„íŠ¼ -->
    <div class="panel">
      <button type="submit" id="runBtn">ì´ë¯¸ì§€ í¸ì§‘í•˜ê¸°</button>
    </div>
  </form>

  <!-- ê²°ê³¼ ì˜ì—­ -->
  <div class="panel">
    <strong>7. ê²°ê³¼</strong>
    <div id="result">ì•„ì§ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
  </div>

  <!-- ğŸ§  ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ (ëª¨ë“ˆ) -->
  <script type="module">
    import removeBackground from "https://cdn.skypack.dev/@imgly/background-removal";

    // ìŠ¬ë¼ì´ë” ê°’ í‘œì‹œ
    const sliderPairs = [
      ["brightness", "brightnessVal"],
      ["saturation", "saturationVal"],
      ["contrast", "contrastVal"],
      ["hue", "hueVal"],
      ["lineStrength", "lineStrengthVal"],
    ];

    sliderPairs.forEach(([inputId, labelId]) => {
      const input = document.getElementById(inputId);
      const label = document.getElementById(labelId);
      label.textContent = input.value;
      input.addEventListener("input", () => {
        label.textContent = input.value;
      });
    });

    const form = document.getElementById("editForm");
    const resultBox = document.getElementById("result");
    const runBtn = document.getElementById("runBtn");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const files = document.getElementById("images").files;
      if (!files || files.length === 0) {
        alert("ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
      }

      const useAiBg = document.getElementById("useAiBg").checked;

      const fd = new FormData();

      // ğŸ”¹ 1) íŒŒì¼ ì²˜ë¦¬: AI ë°°ê²½ ì œê±° â†’ ì—†ìœ¼ë©´ ì›ë³¸ ì‚¬ìš©
      resultBox.textContent = "ì´ë¯¸ì§€ ë°°ê²½ì„ ì œê±°í•˜ê³  ìˆìŠµë‹ˆë‹¤ (AI)...";
      const fileList = Array.from(files);

      for (const file of fileList) {
        let workingFile = file;

        if (useAiBg) {
          try {
            // AIë¡œ ë°°ê²½ ì œê±° (ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰)
            const blobNoBg = await removeBackground(file);
            const cleanName =
              (file.name.replace(/\.[^/.]+$/, "") || "image") + "-nobg.png";
            workingFile = new File([blobNoBg], cleanName, {
              type: "image/png",
            });
          } catch (err) {
            console.error("AI ë°°ê²½ ì œê±° ì‹¤íŒ¨, ì›ë³¸ ì‚¬ìš©:", err);
            // ì‹¤íŒ¨í•˜ë©´ ê·¸ëƒ¥ ì›ë³¸ íŒŒì¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
          }
        }

        fd.append("images", workingFile);
      }

      // ğŸ”¹ 2) ë‚˜ë¨¸ì§€ ì˜µì…˜ë“¤ FormDataì— ì¶”ê°€

      // í¬ê¸° ê´€ë ¨
      fd.append("doResize", document.getElementById("doResize").checked ? "1" : "0");
      fd.append("width", document.getElementById("width").value || "512");
      fd.append("height", document.getElementById("height").value || "512");
      fd.append("fitMode", document.getElementById("fitMode").value);
      fd.append("keepRatio", document.getElementById("keepRatio").checked ? "1" : "0");

      // ë°°ê²½ / ìƒ‰ê°
      // ğŸ‘‰ AIë¥¼ ì“°ë©´ ì„œë²„ ìª½ ë‹¨ìˆœ ë°°ê²½ ì œê±°ëŠ” ë„ê¸°
      const makeTransparent = !useAiBg && document.getElementById("makeTransparent").checked;
      fd.append("makeTransparent", makeTransparent ? "1" : "0");

      fd.append("brightness", document.getElementById("brightness").value || "0");
      fd.append("saturation", document.getElementById("saturation").value || "0");
      fd.append("contrast", document.getElementById("contrast").value || "0");
      fd.append("hue", document.getElementById("hue").value || "0");

      // ë¼ì¸
      fd.append("lineStrength", document.getElementById("lineStrength").value || "0");
      fd.append("lineColor", document.getElementById("lineColor").value);

      // í…ìŠ¤íŠ¸
      fd.append("overlayText", document.getElementById("overlayText").value || "");
      fd.append("textSize", document.getElementById("textSize").value || "32");
      fd.append("textColor", document.getElementById("textColor").value);
      fd.append("textPosition", document.getElementById("textPosition").value);

      try {
        runBtn.disabled = true;
        runBtn.textContent = "ì²˜ë¦¬ ì¤‘...";
        resultBox.textContent = "ì„œë²„ì—ì„œ ì´ë¯¸ì§€ë¥¼ í¸ì§‘í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...";

        const res = await fetch("/api/unify", {
          method: "POST",
          body: fd,
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || ("HTTP " + res.status));
        }

        const data = await res.json();
        resultBox.innerHTML = "";

        if (!data.images || data.images.length === 0) {
          resultBox.textContent = "ê²°ê³¼ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        // ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° + ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
        data.images.forEach((src, index) => {
          const item = document.createElement("div");
          item.className = "result-item";

          const frame = document.createElement("div");
          frame.className = "result-preview-frame";

          const imgDiv = document.createElement("div");
          imgDiv.className = "result-preview-img";
          imgDiv.style.backgroundImage = `url('${src}')`;

          frame.appendChild(imgDiv);

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "download-btn";
          btn.textContent = "ë‹¤ìš´ë¡œë“œ";

          btn.addEventListener("click", () => {
            const a = document.createElement("a");
            a.href = src;
            a.download = `edited-image-${index + 1}.png`;
            document.body.appendChild(a);
            a.click();
            a.remove();
          });

          item.appendChild(frame);
          item.appendChild(btn);
          resultBox.appendChild(item);
        });
      } catch (err) {
        console.error(err);
        alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
        resultBox.textContent = "ì˜¤ë¥˜: " + err.message;
      } finally {
        runBtn.disabled = false;
        runBtn.textContent = "ì´ë¯¸ì§€ í¸ì§‘í•˜ê¸°";
      }
    });
  </script>
</body>
</html>
